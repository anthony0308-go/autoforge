{% extends 'mantenimiento/base.html' %}
{% block title %}Clientes | AutoForge{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold mb-6 text-[#D7141A]">Clientes registrados</h2>

<div class="flex justify-between items-center mb-4">
  <form method="get" class="flex gap-2">
    <input type="text" name="buscar" value="{{ buscar }}" placeholder="Buscar cliente..."
           class="border border-gray-300 px-4 py-2 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#D7141A]">
    <button type="submit"
            class="px-4 py-2 bg-[#1565C0] text-white rounded hover:bg-[#0D47A1] transition font-semibold">Buscar</button>
  </form>
  <a href="{% url 'crear_cliente' %}" class="px-4 py-2 bg-[#1565C0] text-white rounded shadow hover:bg-[#0D47A1] transition font-semibold">
    + Nuevo Cliente
  </a>
</div>

<div class="overflow-x-auto bg-white shadow-md rounded-lg">
  <table class="min-w-full table-auto border-collapse">
    <thead class="bg-[#263238] text-white">
      <tr>
        <th class="py-3 px-4 text-left">Nombre</th>
        <th class="py-3 px-4 text-left">Correo</th>
        <th class="py-3 px-4 text-left">Teléfono</th>
        <th class="py-3 px-4 text-left">Acciones</th>
      </tr>
    </thead>
    <tbody class="text-sm text-gray-800">
      {% for cliente in clientes %}
        <tr class="border-b hover:bg-gray-50" id="cliente-row-{{ cliente.id }}">
          <td class="py-2 px-4">{{ cliente.get_full_name }}</td>
          <td class="py-2 px-4">{{ cliente.email }}</td>
          <td class="py-2 px-4">{{ cliente.telefono }}</td>
          <td class="py-2 px-4 flex gap-2">
            <a href="{% url 'detalle_cliente' cliente.id %}" class="text-[#1565C0] font-semibold hover:underline">Ver</a>
            <button type="button"
                    class="text-[#D7141A] font-semibold hover:underline btn-eliminar-cliente"
                    data-cliente-id="{{ cliente.id }}"
                    data-cliente-nombre="{{ cliente.get_full_name }}">
              Eliminar
            </button>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="4" class="py-4 text-center text-gray-500 italic">No hay clientes registrados.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Botón eliminar cliente
  document.querySelectorAll('.btn-eliminar-cliente').forEach(btn => {
    btn.addEventListener('click', function () {
      const clienteId = this.getAttribute('data-cliente-id');
      const clienteNombre = this.getAttribute('data-cliente-nombre');
      Swal.fire({
        title: '¿Eliminar cliente?',
        html: `<b>${clienteNombre}</b> será eliminado.<br>Esta acción no se puede deshacer.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#D7141A',
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/clientes/${clienteId}/eliminar/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'X-Requested-With': 'XMLHttpRequest'
            },
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              Swal.fire({
                title: '¡Eliminado!',
                text: data.message,
                icon: 'success'
              }).then(() => {
                // Eliminar la fila de la tabla
                const row = document.getElementById(`cliente-row-${clienteId}`);
                if (row) row.remove();
              });
            } else {
              Swal.fire('Error', data.error || 'No se pudo eliminar el cliente.', 'error');
            }
          })
          .catch(() => {
            Swal.fire('Error', 'No se pudo procesar la solicitud.', 'error');
          });
        }
      });
    });
  });
});
</script>
{% endblock %}
