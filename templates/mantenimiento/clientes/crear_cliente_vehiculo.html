{% extends 'mantenimiento/base.html' %}

{% block content %}
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-8 mt-6">
    <h2 class="text-3xl font-bold mb-6 text-[#D7141A]">Registrar Cliente y Veh√≠culo</h2>

    <form id="crearClienteVehiculoForm" method="post" enctype="multipart/form-data" class="space-y-6">
      {% csrf_token %}

      <!-- DATOS DEL CLIENTE -->
      <fieldset class="border border-gray-300 p-4 rounded">
        <legend class="text-lg font-semibold text-gray-700 px-2">Informaci√≥n del Cliente</legend>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium">Nombre</label>
            {{ cliente_form.first_name }}
          </div>
          <div>
            <label class="block text-sm font-medium">Apellido</label>
            {{ cliente_form.last_name }}
          </div>
          <div>
            <label class="block text-sm font-medium">Correo electr√≥nico</label>
            {{ cliente_form.email }}
          </div>
          <div>
            <label class="block text-sm font-medium">Tel√©fono</label>
            {{ cliente_form.telefono }}
          </div>
          <div>
            <label class="block text-sm font-medium">DUI</label>
            {{ cliente_form.dui }}
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium">Direcci√≥n</label>
            {{ cliente_form.direccion }}
          </div>
        </div>
      </fieldset>

      <!-- DATOS DEL VEH√çCULO -->
      <fieldset class="border border-gray-300 p-4 rounded">
        <legend class="text-lg font-semibold text-gray-700 px-2">Informaci√≥n del Veh√≠culo</legend>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium">Tipo de Placa</label>
            {{ vehiculo_form.tipo_placa }}
          </div>
          <div>
            <label class="block text-sm font-medium">Placa</label>
            {{ vehiculo_form.placa }}
          </div>
          <div>
            <label class="block text-sm font-medium">Marca</label>
            {{ vehiculo_form.marca }}
          </div>
          <div>
            <label class="block text-sm font-medium">Modelo</label>
            {{ vehiculo_form.modelo }}
          </div>
          <div>
            <label class="block text-sm font-medium">A√±o</label>
            {{ vehiculo_form.anio }}
          </div>
          <div>
            <label class="block text-sm font-medium">Color</label>
            {{ vehiculo_form.color }}
          </div>
          <div>
            <label class="block text-sm font-medium">Tipo de combustible</label>
            {{ vehiculo_form.tipo_combustible }}
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium">VIN</label>
            {{ vehiculo_form.vin }}
          </div>
        </div>
      </fieldset>

      <!-- FOTOS DEL VEH√çCULO -->
      <fieldset class="border border-gray-300 p-4 rounded">
        <legend class="text-lg font-semibold text-gray-700 px-2">Fotograf√≠as del Veh√≠culo</legend>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium">Foto frontal</label>
            {{ vehiculo_form.foto_frontal }}
          </div>
          <div>
            <label class="block text-sm font-medium">Foto lateral izquierda</label>
            {{ vehiculo_form.foto_lateral_izquierda }}
          </div>
          <div>
            <label class="block text-sm font-medium">Foto lateral derecha</label>
            {{ vehiculo_form.foto_lateral_derecha }}
          </div>
          <div>
            <label class="block text-sm font-medium">Foto trasera</label>
            {{ vehiculo_form.foto_trasera }}
          </div>
        </div>
      </fieldset>

      <!-- BOT√ìN SUBMIT -->
      <div class="text-right">
        <button type="submit" class="px-6 py-2 bg-[#1565C0] text-white rounded hover:bg-[#0D47A1] transition">üíæ Guardar cliente y veh√≠culo</button>
      </div>
    </form>
  </div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // M√°scaras para tel√©fono, DUI, placa y VIN
  const telefonoInput = document.querySelector('#id_telefono');
  if (telefonoInput) {
    telefonoInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 4) {
        value = value.substring(0, 4) + '-' + value.substring(4, 8);
      }
      e.target.value = value;
    });
  }
  const duiInput = document.querySelector('#id_dui');
  if (duiInput) {
    duiInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 8) {
        value = value.substring(0, 8) + '-' + value.substring(8, 9);
      }
      e.target.value = value;
    });
  }
  const placaInput = document.querySelector('#id_placa');
  if (placaInput) {
    placaInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '').slice(0, 6);
      e.target.value = value;
    });
  }
  const vinInput = document.querySelector('#id_vin');
  if (vinInput) {
    vinInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/[^A-Za-z0-9]/g, '').slice(0, 17);
      e.target.value = value;
    });
  }

  // --- AJAX y validaciones ---
  const form = document.getElementById('crearClienteVehiculoForm');
  let submitEnProgreso = false;
  if (form) {
    form.addEventListener('submit', function (event) {
      event.preventDefault();
      if (submitEnProgreso) return;
      submitEnProgreso = true;
      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) submitButton.disabled = true;

      // Validaci√≥n SOLO visual b√°sica de campos requeridos (cliente y veh√≠culo)
      const camposCliente = [
        { id: 'id_first_name', label: 'Nombre' },
        { id: 'id_last_name', label: 'Apellido' },
        { id: 'id_email', label: 'Correo electr√≥nico' },
        { id: 'id_telefono', label: 'Tel√©fono' },
        { id: 'id_dui', label: 'DUI' },
        { id: 'id_direccion', label: 'Direcci√≥n' }
      ];
      let camposVaciosCliente = [];
      let errores = [];
      for (const campo of camposCliente) {
        const input = document.getElementById(campo.id);
        if (input && !input.value.trim()) {
          camposVaciosCliente.push(campo.label);
        }
      }
      // Validar correo, tel√©fono y DUI
      const emailInput = document.getElementById('id_email');
      if (emailInput && emailInput.value.trim()) {
        const re = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
        if (!re.test(emailInput.value.trim())) {
          errores.push('El correo electr√≥nico no es v√°lido.');
        }
      }
      const telInput = document.getElementById('id_telefono');
      if (telInput && telInput.value.trim() && !/^\d{4}-\d{4}$/.test(telInput.value.trim())) {
        errores.push('El tel√©fono debe tener el formato 1234-5678.');
      }
      if (duiInput && duiInput.value.trim() && !/^\d{8}-\d{1}$/.test(duiInput.value.trim())) {
        errores.push('El DUI debe tener el formato 12345678-9.');
      }

      // Validaci√≥n de campos requeridos de veh√≠culo
      const camposVehiculo = [
        { id: 'id_tipo_placa', label: 'Tipo de placa' },
        { id: 'id_placa', label: 'Placa' },
        { id: 'id_marca', label: 'Marca' },
        { id: 'id_modelo', label: 'Modelo' },
        { id: 'id_anio', label: 'A√±o' },
        { id: 'id_color', label: 'Color' },
        { id: 'id_tipo_combustible', label: 'Tipo de combustible' },
        { id: 'id_vin', label: 'VIN' }
      ];
      let camposVaciosVehiculo = [];
      for (const campo of camposVehiculo) {
        const input = document.getElementById(campo.id);
        if (input && !input.value.trim()) {
          camposVaciosVehiculo.push(campo.label);
        }
      }
      if (placaInput && placaInput.value.trim() && !/^\d{6}$/.test(placaInput.value.trim())) {
        errores.push('La placa debe tener exactamente 6 d√≠gitos num√©ricos.');
      }
      if (vinInput && vinInput.value.trim() && !/^[A-HJ-NPR-Z0-9]{17}$/.test(vinInput.value.trim())) {
        errores.push('El VIN debe tener exactamente 17 caracteres alfanum√©ricos (sin I, O, Q).');
      }

      // Validaci√≥n de fotos requeridas
      const camposFotos = [
        { id: 'id_foto_frontal', label: 'Foto frontal' },
        { id: 'id_foto_lateral_izquierda', label: 'Foto lateral izquierda' },
        { id: 'id_foto_lateral_derecha', label: 'Foto lateral derecha' },
        { id: 'id_foto_trasera', label: 'Foto trasera' }
      ];
      let faltantes = [];
      for (const campo of camposFotos) {
        const input = document.getElementById(campo.id);
        if (input && !input.value) {
          faltantes.push(campo.label);
        }
      }

      // SOLO mostrar alertas si faltan campos obligatorios (alerta √∫til y corta)
      if (camposVaciosCliente.length > 0 || camposVaciosVehiculo.length > 0 || errores.length > 0 || faltantes.length > 0) {
        let mensajes = [];
        if (camposVaciosCliente.length > 0) {
          mensajes.push('Completa los datos obligatorios del cliente.');
        }
        if (camposVaciosVehiculo.length > 0) {
          mensajes.push('Completa los datos obligatorios del veh√≠culo.');
        }
        if (faltantes.length > 0) {
          mensajes.push('Faltan fotograf√≠as: <b>' + faltantes.join(', ') + '</b>');
        }
        if (errores.length > 0) {
          mensajes.push(errores.join('<br>'));
        }
        Swal.fire({
          icon: 'warning',
          title: 'Campos requeridos',
          html: mensajes.join('<br>'),
          confirmButtonText: 'OK'
        }).then(() => { submitEnProgreso = false; if (submitButton) submitButton.disabled = false; });
        return;
      }

      // Env√≠o AJAX real, solo si pasa validaciones visuales
      const formData = new FormData(form);
      fetch("{% url 'crear_cliente' %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
        .then(response => response.json().catch(() => null))
        .then(data => {
          if (!data) {
            // ERROR DE RED/CONEXI√ìN
            Swal.fire('Error', 'Error inesperado. Int√©ntalo de nuevo.', 'error').then(() => {
              submitEnProgreso = false;
              if (submitButton) submitButton.disabled = false;
            });
            return;
          }
          if (data.success) {
            Swal.fire({
              title: '¬°√âxito!',
              text: data.message,
              icon: 'success',
              confirmButtonText: 'OK'
            }).then(() => {
              window.location.href = "{% url 'listar_clientes' %}";
            });
          } else {
            // SOLO mostramos los mensajes REALES del backend (errores espec√≠ficos)
            let errorMessages = '';
            if (data.errors) {
              if (data.errors.cliente_form) {
                for (const [field, errors] of Object.entries(data.errors.cliente_form)) {
                  errors.forEach(e => (errorMessages += `Cliente - ${field}: ${e.message}<br>`));
                }
              }
              if (data.errors.vehiculo_form) {
                for (const [field, errors] of Object.entries(data.errors.vehiculo_form)) {
                  errors.forEach(e => (errorMessages += `Veh√≠culo - ${field}: ${e.message}<br>`));
                }
              }
              // SOLO esto: errores del backend (reales), sin ning√∫n mensaje gen√©rico extra
              if (data.errors.general) {
                errorMessages += data.errors.general + '<br>';
              }
            }
            // Mostrar solo si hay mensajes concretos (de validaci√≥n real del backend)
            if (errorMessages) {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                html: errorMessages,
                confirmButtonText: 'OK'
              }).then(() => {
                submitEnProgreso = false;
                if (submitButton) submitButton.disabled = false;
              });
            } else {
              // Si no hay mensajes REALES, no mostramos nada
              submitEnProgreso = false;
              if (submitButton) submitButton.disabled = false;
            }
          }
        })
        .catch(() => {
          Swal.fire('Error', 'Error inesperado. Int√©ntalo de nuevo.', 'error').then(() => {
            submitEnProgreso = false;
            if (submitButton) submitButton.disabled = false;
          });
        });
    });
  }
});
</script>
{% endblock %}
{% endblock %}
