{% extends 'mantenimiento/base.html' %}
{% block title %}Registrar VehÃ­culo{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white shadow-md rounded-xl p-8 mt-6">
  <h2 class="text-3xl font-bold mb-6 text-[#D7141A]">Registrar Nuevo VehÃ­culo</h2>
  <form method="post">
    {% csrf_token %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block font-semibold mb-1 text-gray-700">Propietario</label>
        {{ form.id_usuario_propietario }}
      </div>
      <div>
        <label class="block font-semibold mb-1 text-gray-700">Placa</label>
        {{ form.placa }}
      </div>
      <div>
        <label class="block font-semibold mb-1 text-gray-700">Marca</label>
        {{ form.marca }}
      </div>
      <div>
        <label class="block font-semibold mb-1 text-gray-700">Modelo</label>
        {{ form.modelo }}
      </div>
      <div>
        <label class="block font-semibold mb-1 text-gray-700">AÃ±o</label>
        {{ form.anio }}
      </div>
      <div>
        <label class="block font-semibold mb-1 text-gray-700">Tipo de Combustible</label>
        {{ form.tipo_combustible }}
      </div>
      <div>
        <label class="block font-semibold mb-1 text-gray-700">VIN</label>
        {{ form.vin }}
      </div>
      <div>
        <label class="block font-semibold mb-1 text-gray-700">Color</label>
        {{ form.color }}
      </div>
    </div>
    <div class="text-right mt-6">
      <button type="submit" class="px-6 py-2 bg-[#1565C0] text-white rounded hover:bg-[#0D47A1] transition">
        ðŸ’¾ Guardar VehÃ­culo
      </button>
    </div>
  </form>
</div>
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.querySelector('form');
  if (!form) return;

  form.addEventListener('submit', function (event) {
    event.preventDefault();
    const formData = new FormData(form);
    fetch("", {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        Swal.fire({
          icon: 'success',
          title: 'Â¡Ã‰xito!',
          html: data.message,
          confirmButtonText: 'OK'
        }).then(() => {
          window.location.href = "{% url 'listar_vehiculos' %}";
        });
      } else {
        let errores = '';
        if (data.errors) {
          for (const [campo, arr] of Object.entries(data.errors)) {
            arr.forEach(obj => errores += (obj.message + '<br>'));
          }
        }
        Swal.fire({
          icon: 'error',
          title: 'Error en el formulario',
          html: errores || 'Corrige los errores.',
          confirmButtonText: 'OK'
        });
      }
    })
    .catch(() => {
      Swal.fire('Error', 'Error inesperado. IntÃ©ntalo de nuevo.', 'error');
    });
  });
});
document.addEventListener('DOMContentLoaded', function () {
  // --- MÃ¡scaras para placa y VIN ---
  const placaInput = document.querySelector('#id_placa');
  if (placaInput) {
    placaInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '').slice(0, 6);
      e.target.value = value;
    });
  }
  const vinInput = document.querySelector('#id_vin');
  if (vinInput) {
    vinInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/[^A-Za-z0-9]/g, '').slice(0, 17);
      e.target.value = value;
    });
  }
  
  // --- Validaciones y SweetAlert2 ---
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function (event) {
      let errores = [];
      const placa = placaInput ? placaInput.value.trim() : '';
      const vin = vinInput ? vinInput.value.trim() : '';
      
      if (!placa || placa.length !== 6) {
        errores.push('La placa debe tener exactamente 6 dÃ­gitos.');
      }
      if (!vin || !/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
        errores.push('El VIN debe tener exactamente 17 caracteres alfanumÃ©ricos (sin I, O, Q).');
      }
      // Puedes agregar mÃ¡s validaciones aquÃ­ (aÃ±o, modelo, etc.)

      if (errores.length > 0) {
        event.preventDefault();
        Swal.fire({
          icon: 'warning',
          title: 'Errores en el formulario',
          html: errores.join('<br>'),
          confirmButtonText: 'OK'
        });
      }
    });
  }
});
</script>
{% endblock %}
{% endblock %}
